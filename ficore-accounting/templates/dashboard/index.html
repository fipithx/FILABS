{% extends "base.html" %}
{% block title %}{{ t('dashboard_title', default='Dashboard') }}{% endblock %}
{% block content %}
<div class="container mt-5">
    <!-- Breadcrumb Navigation -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('index') }}">{{ t('general_home', default='Home') }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ t('dashboard_title', default='Dashboard') }}</li>
        </ol>
    </nav>

    <!-- Page Title -->
    <div class="page-title">
        <h2>{{ t('dashboard_title', default='Dashboard') }}</h2>
    </div>

    {% if current_user.is_authenticated %}
        {% if current_user.role == 'admin' %}
            <p class="alert alert-info">{{ t('admin_view_all_data', default='You are viewing all users\' data as an admin.') }}</p>
        {% endif %}

        <!-- Personal Finance Section for Personal Users and Admins -->
        {% if current_user.role in ['personal', 'admin'] %}
        <div class="mb-5">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="text-primary">
                    <i class="fas fa-chart-pie me-2"></i>
                    {{ t('general_personal_finance', default='Personal Finance') }}
                </h3>
                {% if personal_finance_summary.has_personal_data %}
                    <small class="text-muted">{{ t('dashboard_personal_finance_overview', default='Your financial overview') }}</small>
                {% endif %}
            </div>

            {% if personal_finance_summary.has_personal_data %}
                <!-- Personal Finance Quick Stats -->
                <div class="row g-3 mb-4">
                    {% if personal_finance_summary.latest_budget %}
                    <div class="col-md-3">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body text-center">
                                <div class="text-primary mb-2">
                                    <i class="fas fa-calculator fa-2x"></i>
                                </div>
                                <h6 class="card-title">{{ t('budget_title', default='Budget') }}</h6>
                                <p class="card-text">
                                    <span class="h5 {{ 'text-success' if personal_finance_summary.latest_budget.surplus_deficit > 0 else 'text-danger' }}">
                                        {{ personal_finance_summary.latest_budget.surplus_deficit | format_currency }}
                                    </span><br>
                                    <small class="text-muted">{{ t('budget_surplus_deficit', default='Surplus/Deficit') }}</small>
                                </p>
                                <a href="{{ url_for('personal.budget.main') }}" class="btn btn-outline-primary btn-sm">{{ t('general_view', default='View') }}</a>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {% if personal_finance_summary.latest_financial_health %}
                    <div class="col-md-3">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body text-center">
                                <div class="text-success mb-2">
                                    <i class="fas fa-heartbeat fa-2x"></i>
                                </div>
                                <h6 class="card-title">{{ t('financial_health_title', default='Health Score') }}</h6>
                                <p class="card-text">
                                    <span class="h5 text-primary">{{ personal_finance_summary.latest_financial_health.score }}/100</span><br>
                                    <small class="text-muted">{{ personal_finance_summary.latest_financial_health.status }}</small>
                                </p>
                                <a href="{{ url_for('personal.financial_health.main') }}" class="btn btn-outline-success btn-sm">{{ t('general_view', default='View') }}</a>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {% if personal_finance_summary.total_bills > 0 %}
                    <div class="col-md-3">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body text-center">
                                <div class="text-warning mb-2">
                                    <i class="fas fa-file-invoice fa-2x"></i>
                                </div>
                                <h6 class="card-title">{{ t('bill_title', default='Bills') }}</h6>
                                <p class="card-text">
                                    <span class="h5 text-primary">{{ personal_finance_summary.total_bills }}</span><br>
                                    <small class="text-muted">
                                        {% if personal_finance_summary.overdue_bills > 0 %}
                                            <span class="text-danger">{{ personal_finance_summary.overdue_bills }} {{ t('bill_overdue', default='overdue') }}</span>
                                        {% else %}
                                            {{ t('bill_all_current', default='All current') }}
                                        {% endif %}
                                    </small>
                                </p>
                                <a href="{{ url_for('personal.bill.main') }}" class="btn btn-outline-warning btn-sm">{{ t('general_view', default='View') }}</a>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {% if personal_finance_summary.latest_net_worth %}
                    <div class="col-md-3">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body text-center">
                                <div class="text-info mb-2">
                                    <i class="fas fa-chart-line fa-2x"></i>
                                </div>
                                <h6 class="card-title">{{ t('net_worth_title', default='Net Worth') }}</h6>
                                <p class="card-text">
                                    <span class="h5 {{ 'text-success' if personal_finance_summary.latest_net_worth.net_worth > 0 else 'text-danger' }}">
                                        {{ personal_finance_summary.latest_net_worth.net_worth | format_currency }}
                                    </span><br>
                                    <small class="text-muted">{{ t('net_worth_total', default='Total Net Worth') }}</small>
                                </p>
                                <a href="{{ url_for('personal.net_worth.main') }}" class="btn btn-outline-info btn-sm">{{ t('general_view', default='View') }}</a>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Personal Finance Quick Actions -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">{{ t('general_quick_actions', default='Quick Actions') }}</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-md-2 col-6">
                                <a href="{{ url_for('personal.budget.main') }}" class="btn btn-outline-primary w-100">
                                    <i class="fas fa-calculator d-block mb-1"></i>
                                    <small>{{ t('budget_title', default='Budget') }}</small>
                                </a>
                            </div>
                            <div class="col-md-2 col-6">
                                <a href="{{ url_for('personal.bill.main') }}" class="btn btn-outline-warning w-100">
                                    <i class="fas fa-file-invoice d-block mb-1"></i>
                                    <small>{{ t('bill_title', default='Bills') }}</small>
                                </a>
                            </div>
                            <div class="col-md-2 col-6">
                                <a href="{{ url_for('personal.emergency_fund.main') }}" class="btn btn-outline-success w-100">
                                    <i class="fas fa-shield-alt d-block mb-1"></i>
                                    <small>{{ t('emergency_fund_title', default='Emergency Fund') }}</small>
                                </a>
                            </div>
                            <div class="col-md-2 col-6">
                                <a href="{{ url_for('personal.financial_health.main') }}" class="btn btn-outline-info w-100">
                                    <i class="fas fa-heartbeat d-block mb-1"></i>
                                    <small>{{ t('financial_health_title', default='Health Score') }}</small>
                                </a>
                            </div>
                            <div class="col-md-2 col-6">
                                <a href="{{ url_for('personal.net_worth.main') }}" class="btn btn-outline-secondary w-100">
                                    <i class="fas fa-chart-line d-block mb-1"></i>
                                    <small>{{ t('net_worth_title', default='Net Worth') }}</small>
                                </a>
                            </div>
                            <div class="col-md-2 col-6">
                                <a href="{{ url_for('learning_hub.main') }}" class="btn btn-outline-dark w-100">
                                    <i class="fas fa-graduation-cap d-block mb-1"></i>
                                    <small>{{ t('learning_hub_title', default='Learning') }}</small>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            {% else %}
                <!-- Getting Started Section for Personal Users -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body text-center py-5">
                        <div class="mb-4">
                            <i class="fas fa-chart-pie fa-4x text-primary opacity-50"></i>
                        </div>
                        <h4 class="mb-3">{{ t('dashboard_welcome_personal_finance', default='Welcome to Personal Finance') }}</h4>
                        <p class="text-muted mb-4">{{ t('dashboard_personal_finance_intro', default='Take control of your finances with our comprehensive personal finance tools. Start by creating your first budget or tracking your bills.') }}</p>
                        <div class="row g-2 justify-content-center">
                            <div class="col-md-2 col-6">
                                <a href="{{ url_for('personal.budget.main') }}" class="btn btn-primary w-100">
                                    <i class="fas fa-calculator d-block mb-1"></i>
                                    <small>{{ t('budget_create_first', default='Create Budget') }}</small>
                                </a>
                            </div>
                            <div class="col-md-2 col-6">
                                <a href="{{ url_for('personal.bill.main') }}" class="btn btn-outline-primary w-100">
                                    <i class="fas fa-file-invoice d-block mb-1"></i>
                                    <small>{{ t('bill_add_first', default='Add Bills') }}</small>
                                </a>
                            </div>
                            <div class="col-md-2 col-6">
                                <a href="{{ url_for('personal.quiz.main') }}" class="btn btn-outline-primary w-100">
                                    <i class="fas fa-question-circle d-block mb-1"></i>
                                    <small>{{ t('quiz_take_first', default='Take Quiz') }}</small>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Trader/Business Section for Traders and Admins -->
        {% if current_user.role in ['trader', 'admin'] %}
        <div class="mb-4">
            <h3>{{ t('general_quick_actions', default='Quick Actions') }}</h3>
            <div class="d-flex flex-wrap gap-2">
                <a href="{{ url_for('creditors.add') }}" class="btn btn-primary">{{ t('creditors_create_what_you_owe', default='Create What You Owe') }}</a>
                <a href="{{ url_for('debtors.add') }}" class="btn btn-primary">{{ t('debtors_create_what_they_owe_you', default='Create What They Owe You') }}</a>
                <a href="{{ url_for('payments.add') }}" class="btn btn-primary">{{ t('payments_add_money_out', default='Add Money Out') }}</a>
                <a href="{{ url_for('receipts.add') }}" class="btn btn-primary">{{ t('receipts_add_money_in', default='Add Money In') }}</a>
                <a href="{{ url_for('inventory.add') }}" class="btn btn-primary">{{ t('inventory_add_goods_stock', default='Add Goods & Stock') }}</a>
                <a href="{{ url_for('credits.add') }}" class="btn btn-success">{{ t('credits_add_credits', default='Add Ficore Credits') }}</a>
                {% if current_user.role == 'admin' %}
                    <a href="{{ url_for('admin.dashboard') }}" class="btn btn-warning">{{ t('admin_dashboard', default='Admin Dashboard') }}</a>
                {% endif %}
            </div>
        </div>

        <div class="row g-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h3>{{ t('creditors_what_you_owe', default='What You Owe') }}</h3>
                        <small class="subtext">{{ t('creditors_what_you_owe_subtext', default='Kuɗin da Mutane ke Bin Ka') }}</small>
                        {% if recent_creditors %}
                            <table class="table table-striped mt-3">
                                <thead>
                                    <tr>
                                        <th>{{ t('general_name', default='Name') }}</th>
                                        <th>{{ t('general_amount', default='Amount') }}</th>
                                        <th>{{ t('general_actions', default='Actions') }}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for creditor in recent_creditors %}
                                        <tr>
                                            <td>{{ creditor.name }}</td>
                                            <td>{{ creditor.amount_owed | format_currency }}</td>
                                            <td>
                                                <button class="btn btn-secondary btn-sm actions-btn"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#creditorActionsModal"
                                                        data-id="{{ creditor._id }}"
                                                        data-name="{{ creditor.name }}"
                                                        data-amount="{{ creditor.amount_owed }}"
                                                        data-contact="{{ creditor.contact or '' }}"
                                                        data-date="{{ format_date(creditor.created_at) }}"
                                                        data-description="{{ creditor.description or '' }}">
                                                    {{ t('general_actions', default='Actions') }}
                                                </button>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        {% else %}
                            <p>{{ t('creditors_no_what_you_owe', default='You don\'t owe anyone yet.') }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h3>{{ t('debtors_what_they_owe_you', default='What They Owe You') }}</h3>
                        <small class="subtext">{{ t('debtors_what_they_owe_you_subtext', default='Kuɗin da Kake Bin Wasu') }}</small>
                        {% if recent_debtors %}
                            <table class="table table-striped mt-3">
                                <thead>
                                    <tr>
                                        <th>{{ t('general_name', default='Name') }}</th>
                                        <th>{{ t('general_amount', default='Amount') }}</th>
                                        <th>{{ t('general_actions', default='Actions') }}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for debtor in recent_debtors %}
                                        <tr>
                                            <td>{{ debtor.name }}</td>
                                            <td>{{ debtor.amount_owed | format_currency }}</td>
                                            <td>
                                                <button class="btn btn-secondary btn-sm actions-btn"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#debtorActionsModal"
                                                        data-id="{{ debtor._id }}"
                                                        data-name="{{ debtor.name }}"
                                                        data-amount="{{ debtor.amount_owed }}"
                                                        data-contact="{{ debtor.contact or '' }}"
                                                        data-date="{{ format_date(debtor.created_at) }}"
                                                        data-reminders="{{ debtor.get('reminder_count', 0) }}"
                                                        data-description="{{ debtor.description or '' }}">
                                                    {{ t('general_actions', default='Actions') }}
                                                </button>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        {% else %}
                            <p>{{ t('debtors_no_what_they_owe_you', default='No one owes you yet.') }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h3>{{ t('payments_money_out', default='Money Out') }}</h3>
                        <small class="subtext">{{ t('payments_money_out_subtext', default='Track your expenses and payments') }}</small>
                        {% if recent_payments %}
                            <table class="table table-striped mt-3">
                                <thead>
                                    <tr>
                                        <th>{{ t('payments_recipient', default='Recipient') }}</th>
                                        <th>{{ t('general_amount', default='Amount') }}</th>
                                        <th>{{ t('general_actions', default='Actions') }}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for payment in recent_payments %}
                                        <tr>
                                            <td>{{ payment.recipient }}</td>
                                            <td>{{ payment.amount | format_currency }}</td>
                                            <td>
                                                <button class="btn btn-secondary btn-sm actions-btn"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#paymentActionsModal"
                                                        data-id="{{ payment._id }}"
                                                        data-recipient="{{ payment.recipient }}"
                                                        data-amount="{{ payment.amount }}"
                                                        data-date="{{ format_date(payment.created_at) }}"
                                                        data-description="{{ payment.description or '' }}">
                                                    {{ t('general_actions', default='Actions') }}
                                                </button>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        {% else %}
                            <p>{{ t('payments_no_money_out', default='No money out recorded yet.') }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h3>{{ t('receipts_money_in', default='Money In') }}</h3>
                        <small class="subtext">{{ t('receipts_money_in_subtext', default='Track your income and receipts') }}</small>
                        {% if recent_receipts %}
                            <table class="table table-striped mt-3">
                                <thead>
                                    <tr>
                                        <th>{{ t('receipts_payer', default='Payer') }}</th>
                                        <th>{{ t('general_amount', default='Amount') }}</th>
                                        <th>{{ t('general_actions', default='Actions') }}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for receipt in recent_receipts %}
                                        <tr>
                                            <td>{{ receipt.payer }}</td>
                                            <td>{{ receipt.amount | format_currency }}</td>
                                            <td>
                                                <button class="btn btn-secondary btn-sm actions-btn"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#receiptActionsModal"
                                                        data-id="{{ receipt._id }}"
                                                        data-payer="{{ receipt.payer }}"
                                                        data-amount="{{ receipt.amount }}"
                                                        data-date="{{ format_date(receipt.created_at) }}"
                                                        data-description="{{ receipt.description or '' }}">
                                                    {{ t('general_actions', default='Actions') }}
                                                </button>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        {% else %}
                            <p>{{ t('receipts_no_money_in', default='No money in recorded yet.') }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h3>{{ t('inventory_goods_stock', default='Goods & Stock') }}</h3>
                        <small class="subtext">{{ t('inventory_goods_stock_subtext', default='Track your inventory') }}</small>
                        {% if recent_inventory %}
                            <table class="table table-striped mt-3">
                                <thead>
                                    <tr>
                                        <th>{{ t('inventory_item_name', default='Item Name') }}</th>
                                        <th>{{ t('inventory_quantity', default='Quantity') }}</th>
                                        <th>{{ t('general_actions', default='Actions') }}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in recent_inventory %}
                                        <tr>
                                            <td>{{ item.name }}</td>
                                            <td>{{ item.quantity }}</td>
                                            <td>
                                                <button class="btn btn-secondary btn-sm actions-btn"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#inventoryActionsModal"
                                                        data-id="{{ item._id }}"
                                                        data-name="{{ item.name }}"
                                                        data-quantity="{{ item.quantity }}"
                                                        data-unit="{{ item.unit or '' }}"
                                                        data-buying-price="{{ item.buying_price or '' }}"
                                                        data-selling-price="{{ item.selling_price or '' }}"
                                                        data-threshold="{{ item.threshold or 5 }}">
                                                    {{ t('general_actions', default='Actions') }}
                                                </button>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        {% else %}
                            <p>{{ t('inventory_no_inventory', default='No inventory recorded yet.') }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    {% else %}
        <div class="text-center py-5">
            <h3>{{ t('dashboard_welcome_to_ficore', default='Welcome to FiCore') }}</h3>
            <p class="text-muted">{{ t('dashboard_please_login', default='Please log in to view your dashboard.') }}</p>
            <a href="{{ url_for('users.login') }}" class="btn btn-primary">{{ t('general_login', default='Log In') }}</a>
        </div>
    {% endif %}

    <!-- Creditor Actions Modal -->
    <div class="modal fade" id="creditorActionsModal" tabindex="-1" aria-labelledby="creditorActionsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="creditorActionsModalLabel">{{ t('creditors_what_you_owe', default='What You Owe') }}</h5>
                    <button class="btn-close" data-bs-dismiss="modal" aria-label="{{ t('general_close', default='Close') }}"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>{{ t('general_name', default='Name') }}:</strong> <span id="creditorModalName"></span></p>
                            <p><strong>{{ t('general_amount', default='Amount') }}:</strong> <span id="creditorModalAmount"></span></p>
                            <p><strong>{{ t('general_contact', default='Contact') }}:</strong> <span id="creditorModalContact"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>{{ t('general_description', default='Description') }}:</strong> <span id="creditorModalDescription"></span></p>
                            <p><strong>{{ t('general_date', default='Date') }}:</strong> <span id="creditorModalDate"></span></p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <a id="creditorViewBtn" class="btn btn-info" href="#">{{ t('general_view', default='View') }}</a>
                    <button id="creditorShareBtn" class="btn btn-success" style="display: none;">{{ t('general_share', default='Share') }}</button>
                    <a id="creditorEditBtn" class="btn btn-primary" href="#">{{ t('general_edit', default='Edit') }}</a>
                    <form id="creditorDeleteForm" action="#" method="POST" style="display:inline;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-danger" onclick="return confirm('{{ t('general_confirm_delete', default='Are you sure?') }}')">
                            {{ t('general_delete', default='Delete') }}
                        </button>
                    </form>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ t('general_close', default='Close') }}</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Debtor Actions Modal -->
    <div class="modal fade" id="debtorActionsModal" tabindex="-1" aria-labelledby="debtorActionsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="debtorActionsModalLabel">{{ t('debtors_what_they_owe_you', default='What They Owe You') }}</h5>
                    <button class="btn-close" data-bs-dismiss="modal" aria-label="{{ t('general_close', default='Close') }}"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>{{ t('general_name', default='Name') }}:</strong> <span id="debtorModalName"></span></p>
                            <p><strong>{{ t('general_amount', default='Amount') }}:</strong> <span id="debtorModalAmount"></span></p>
                            <p><strong>{{ t('general_contact', default='Contact') }}:</strong> <span id="debtorModalContact"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>{{ t('general_description', default='Description') }}:</strong> <span id="debtorModalDescription"></span></p>
                            <p><strong>{{ t('general_date', default='Date') }}:</strong> <span id="debtorModalDate"></span></p>
                            <p><strong>{{ t('debtors_reminders', default='Reminders') }}:</strong> <span id="debtorModalReminders"></span></p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <a id="debtorViewBtn" class="btn btn-info" href="#">{{ t('general_view', default='View') }}</a>
                    <button id="debtorReminderBtn" class="btn btn-warning" style="display: none;">{{ t('general_reminder', default='Reminder') }}</button>
                    <button id="debtorSnoozeBtn" class="btn btn-primary" style="display: none;">{{ t('general_snooze', default='Snooze') }}</button>
                    <button id="debtorShareBtn" class="btn btn-success" style="display: none;">{{ t('general_share', default='Share') }}</button>
                    <a id="debtorEditBtn" class="btn btn-primary" href="#">{{ t('general_edit', default='Edit') }}</a>
                    <form id="debtorDeleteForm" action="#" method="POST" style="display:inline;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-danger" onclick="return confirm('{{ t('general_confirm_delete', default='Are you sure?') }}')">
                            {{ t('general_delete', default='Delete') }}
                        </button>
                    </form>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ t('general_close', default='Close') }}</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Actions Modal -->
    <div class="modal fade" id="paymentActionsModal" tabindex="-1" aria-labelledby="paymentActionsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="paymentActionsModalLabel">{{ t('payments_money_out', default='Money Out') }}</h5>
                    <button class="btn-close" data-bs-dismiss="modal" aria-label="{{ t('general_close', default='Close') }}"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>{{ t('payments_recipient', default='Recipient') }}:</strong> <span id="paymentModalRecipient"></span></p>
                            <p><strong>{{ t('general_amount', default='Amount') }}:</strong> <span id="paymentModalAmount"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>{{ t('general_description', default='Description') }}:</strong> <span id="paymentModalDescription"></span></p>
                            <p><strong>{{ t('general_date', default='Date') }}:</strong> <span id="paymentModalDate"></span></p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <a id="paymentViewBtn" class="btn btn-info" href="#">{{ t('general_view', default='View') }}</a>
                    <a id="paymentEditBtn" class="btn btn-primary" href="#">{{ t('general_edit', default='Edit') }}</a>
                    <form id="paymentDeleteForm" action="#" method="POST" style="display:inline;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-danger" onclick="return confirm('{{ t('general_confirm_delete', default='Are you sure?') }}')">
                            {{ t('general_delete', default='Delete') }}
                        </button>
                    </form>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ t('general_close', default='Close') }}</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Receipt Actions Modal -->
    <div class="modal fade" id="receiptActionsModal" tabindex="-1" aria-labelledby="receiptActionsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="receiptActionsModalLabel">{{ t('receipts_money_in', default='Money In') }}</h5>
                    <button class="btn-close" data-bs-dismiss="modal" aria-label="{{ t('general_close', default='Close') }}"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>{{ t('receipts_payer', default='Payer') }}:</strong> <span id="receiptModalPayer"></span></p>
                            <p><strong>{{ t('general_amount', default='Amount') }}:</strong> <span id="receiptModalAmount"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>{{ t('general_description', default='Description') }}:</strong> <span id="receiptModalDescription"></span></p>
                            <p><strong>{{ t('general_date', default='Date') }}:</strong> <span id="receiptModalDate"></span></p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <a id="receiptViewBtn" class="btn btn-info" href="#">{{ t('general_view', default='View') }}</a>
                    <a id="receiptEditBtn" class="btn btn-primary" href="#">{{ t('general_edit', default='Edit') }}</a>
                    <form id="receiptDeleteForm" action="#" method="POST" style="display:inline;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-danger" onclick="return confirm('{{ t('general_confirm_delete', default='Are you sure?') }}')">
                            {{ t('general_delete', default='Delete') }}
                        </button>
                    </form>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ t('general_close', default='Close') }}</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Inventory Actions Modal -->
    <div class="modal fade" id="inventoryActionsModal" tabindex="-1" aria-labelledby="inventoryActionsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="inventoryActionsModalLabel">{{ t('inventory_goods_stock', default='Goods & Stock') }}</h5>
                    <button class="btn-close" data-bs-dismiss="modal" aria-label="{{ t('general_close', default='Close') }}"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>{{ t('inventory_item_name', default='Item Name') }}:</strong> <span id="inventoryModalName"></span></p>
                            <p><strong>{{ t('inventory_quantity', default='Quantity') }}:</strong> <span id="inventoryModalQuantity"></span></p>
                            <p><strong>{{ t('inventory_unit', default='Unit') }}:</strong> <span id="inventoryModalUnit"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>{{ t('inventory_buying_price', default='Buying Price') }}:</strong> <span id="inventoryModalBuyingPrice"></span></p>
                            <p><strong>{{ t('inventory_selling_price', default='Selling Price') }}:</strong> <span id="inventoryModalSellingPrice"></span></p>
                            <p><strong>{{ t('inventory_threshold', default='Threshold') }}:</strong> <span id="inventoryModalThreshold"></span></p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <a id="inventoryViewBtn" class="btn btn-info" href="#">{{ t('general_view', default='View') }}</a>
                    <a id="inventoryEditBtn" class="btn btn-primary" href="#">{{ t('general_edit', default='Edit') }}</a>
                    <form id="inventoryDeleteForm" action="#" method="POST" style="display:inline;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-danger" onclick="return confirm('{{ t('general_confirm_delete', default='Are you sure?') }}')">
                            {{ t('general_delete', default='Delete') }}
                        </button>
                    </form>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ t('general_close', default='Close') }}</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reminder Modal -->
    <div class="modal fade" id="reminderModal" tabindex="-1" aria-labelledby="reminderModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reminderModalLabel">{{ t('general_send_reminder', default='Send Reminder') }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ t('general_close', default='Close') }}"></button>
                </div>
                <div class="modal-body">
                    <form id="reminderForm">
                        <div class="mb-3">
                            <label for="reminderType" class="form-label">{{ t('general_reminder_type', default='Reminder Type') }}</label>
                            <select class="form-select" id="reminderType" required>
                                <option value="sms">{{ t('general_sms', default='SMS') }}</option>
                                <option value="whatsapp">{{ t('general_whatsapp', default='WhatsApp') }}</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="reminderMessage" class="form-label">{{ t('general_message', default='Message') }}</label>
                            <textarea class="form-control" id="reminderMessage" rows="4" required></textarea>
                            <div class="form-text">{{ t('general_reminder_cost', default='Cost: 2 Ficore Credits per reminder') }}</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="sendReminderBtn">
                        {{ t('general_send_reminder', default='Send Reminder') }}
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        {{ t('general_cancel', default='Cancel') }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Snooze Modal -->
    <div class="modal fade" id="snoozeModal" tabindex="-1" aria-labelledby="snoozeModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="snoozeModalLabel">{{ t('general_snooze_reminder', default='Snooze Reminder') }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ t('general_close', default='Close') }}"></button>
                </div>
                <div class="modal-body">
                    <form id="snoozeForm">
                        <div class="mb-3">
                            <label for="snoozeDays" class="form-label">{{ t('general_snooze_duration', default='Snooze Duration') }}</label>
                            <select class="form-select" id="snoozeDays" required>
                                <option value="1">{{ t('general_1_day', default='1 Day') }}</option>
                                <option value="3">{{ t('general_3_days', default='3 Days') }}</option>
                                <option value="7">{{ t('general_7_days', default='7 Days') }}</option>
                                <option value="14">{{ t('general_14_days', default='14 Days') }}</option>
                            </select>
                            <div class="form-text">{{ t('general_snooze_cost', default='Cost: 1 Ficore Credit per snooze') }}</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="snoozeReminderBtn">
                        {{ t('general_snooze', default='Snooze') }}
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        {{ t('general_cancel', default='Cancel') }}
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Initialize tooltips
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));

    let currentData = null;

    // Creditor Actions
    document.querySelectorAll('#creditorActionsModal').forEach(modal => {
        modal.addEventListener('show.bs.modal', (event) => {
            const button = event.relatedTarget;
            currentData = {
                _id: button.dataset.id,
                name: button.dataset.name,
                amount: parseFloat(button.dataset.amount).toLocaleString(),
                contact: button.dataset.contact,
                date: button.dataset.date,
                description: button.dataset.description
            };

            // Populate modal
            document.getElementById('creditorModalName').textContent = currentData.name;
            document.getElementById('creditorModalAmount').textContent = `{{ t('general_currency_symbol', default='₦') }}${currentData.amount}`;
            document.getElementById('creditorModalContact').textContent = currentData.contact || '-';
            document.getElementById('creditorModalDescription').textContent = currentData.description || '-';
            document.getElementById('creditorModalDate').textContent = currentData.date;

            // Update action buttons
            document.getElementById('creditorViewBtn').href = `/creditors/view/${currentData._id}`;
            document.getElementById('creditorEditBtn').href = `/creditors/edit/${currentData._id}`;
            document.getElementById('creditorDeleteForm').action = `/creditors/delete/${currentData._id}`;
            document.getElementById('creditorShareBtn').style.display = currentData.contact ? 'inline-block' : 'none';
        });
    });

    document.getElementById('creditorShareBtn').addEventListener('click', () => {
        if (!currentData || !currentData.contact) {
            alert('{{ t('general_no_contact', default='No contact provided for sharing') }}');
            return;
        }
        fetch(`/creditors/share/${currentData._id}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.open(data.whatsapp_link, '_blank');
                    bootstrap.Modal.getInstance(document.getElementById('creditorActionsModal')).hide();
                } else {
                    alert('{{ t('general_failed_to_share_iou', default='Failed to share IOU') }}: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error sharing IOU:', error);
                alert('{{ t('general_error_sharing_iou', default='Error sharing IOU') }}');
            });
    });

    // Debtor Actions
    document.querySelectorAll('#debtorActionsModal').forEach(modal => {
        modal.addEventListener('show.bs.modal', (event) => {
            const button = event.relatedTarget;
            currentData = {
                _id: button.dataset.id,
                name: button.dataset.name,
                amount: parseFloat(button.dataset.amount).toLocaleString(),
                contact: button.dataset.contact,
                date: button.dataset.date,
                reminders: button.dataset.reminders,
                description: button.dataset.description
            };

            // Populate modal
            document.getElementById('debtorModalName').textContent = currentData.name;
            document.getElementById('debtorModalAmount').textContent = `{{ t('general_currency_symbol', default='₦') }}${currentData.amount}`;
            document.getElementById('debtorModalContact').textContent = currentData.contact || '-';
            document.getElementById('debtorModalDescription').textContent = currentData.description || '-';
            document.getElementById('debtorModalDate').textContent = currentData.date;
            document.getElementById('debtorModalReminders').textContent = currentData.reminders;

            // Update action buttons
            document.getElementById('debtorViewBtn').href = `/debtors/view/${currentData._id}`;
            document.getElementById('debtorEditBtn').href = `/debtors/edit/${currentData._id}`;
            document.getElementById('debtorDeleteForm').action = `/debtors/delete/${currentData._id}`;
            document.getElementById('debtorReminderBtn').style.display = currentData.contact ? 'inline-block' : 'none';
            document.getElementById('debtorSnoozeBtn').style.display = currentData.contact ? 'inline-block' : 'none';
            document.getElementById('debtorShareBtn').style.display = currentData.contact ? 'inline-block' : 'none';
        });
    });

    document.getElementById('debtorReminderBtn').addEventListener('click', () => {
        if (!currentData) return;
        const defaultMessage = `Hi ${currentData.name}, just a reminder you owe {{ t('general_currency_symbol', default='₦') }}${currentData.amount} recorded on FiCore Records (${currentData.date}). Please settle soon.`;
        document.getElementById('reminderMessage').value = defaultMessage;
        new bootstrap.Modal(document.getElementById('reminderModal')).show();
    });

    document.getElementById('debtorSnoozeBtn').addEventListener('click', () => {
        if (!currentData) return;
        new bootstrap.Modal(document.getElementById('snoozeModal')).show();
    });

    document.getElementById('debtorShareBtn').addEventListener('click', () => {
        if (!currentData || !currentData.contact) {
            alert('{{ t('general_no_contact', default='No contact provided for sharing') }}');
            return;
        }
        fetch(`/debtors/share/${currentData._id}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.open(data.whatsapp_link, '_blank');
                    bootstrap.Modal.getInstance(document.getElementById('debtorActionsModal')).hide();
                } else {
                    alert('{{ t('general_failed_to_share_iou', default='Failed to share IOU') }}: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error sharing IOU:', error);
                alert('{{ t('general_error_sharing_iou', default='Error sharing IOU') }}');
            });
    });

    // Payment Actions
    document.querySelectorAll('#paymentActionsModal').forEach(modal => {
        modal.addEventListener('show.bs.modal', (event) => {
            const button = event.relatedTarget;
            currentData = {
                _id: button.dataset.id,
                recipient: button.dataset.recipient,
                amount: parseFloat(button.dataset.amount).toLocaleString(),
                date: button.dataset.date,
                description: button.dataset.description
            };

            // Populate modal
            document.getElementById('paymentModalRecipient').textContent = currentData.recipient;
            document.getElementById('paymentModalAmount').textContent = `{{ t('general_currency_symbol', default='₦') }}${currentData.amount}`;
            document.getElementById('paymentModalDescription').textContent = currentData.description || '-';
            document.getElementById('paymentModalDate').textContent = currentData.date;

            // Update action buttons
            document.getElementById('paymentViewBtn').href = `/payments/view/${currentData._id}`;
            document.getElementById('paymentEditBtn').href = `/payments/edit/${currentData._id}`;
            document.getElementById('paymentDeleteForm').action = `/payments/delete/${currentData._id}`;
        });
    });

    // Receipt Actions
    document.querySelectorAll('#receiptActionsModal').forEach(modal => {
        modal.addEventListener('show.bs.modal', (event) => {
            const button = event.relatedTarget;
            currentData = {
                _id: button.dataset.id,
                payer: button.dataset.payer,
                amount: parseFloat(button.dataset.amount).toLocaleString(),
                date: button.dataset.date,
                description: button.dataset.description
            };

            // Populate modal
            document.getElementById('receiptModalPayer').textContent = currentData.payer;
            document.getElementById('receiptModalAmount').textContent = `{{ t('general_currency_symbol', default='₦') }}${currentData.amount}`;
            document.getElementById('receiptModalDescription').textContent = currentData.description || '-';
            document.getElementById('receiptModalDate').textContent = currentData.date;

            // Update action buttons
            document.getElementById('receiptViewBtn').href = `/receipts/view/${currentData._id}`;
            document.getElementById('receiptEditBtn').href = `/receipts/edit/${currentData._id}`;
            document.getElementById('receiptDeleteForm').action = `/receipts/delete/${currentData._id}`;
        });
    });

    // Inventory Actions
    document.querySelectorAll('#inventoryActionsModal').forEach(modal => {
        modal.addEventListener('show.bs.modal', (event) => {
            const button = event.relatedTarget;
            currentData = {
                _id: button.dataset.id,
                name: button.dataset.name,
                quantity: button.dataset.quantity,
                unit: button.dataset.unit,
                buying_price: button.dataset.buyingPrice ? parseFloat(button.dataset.buyingPrice).toLocaleString() : '-',
                selling_price: button.dataset.sellingPrice ? parseFloat(button.dataset.sellingPrice).toLocaleString() : '-',
                threshold: button.dataset.threshold
            };

            // Populate modal
            document.getElementById('inventoryModalName').textContent = currentData.name;
            document.getElementById('inventoryModalQuantity').textContent = currentData.quantity;
            document.getElementById('inventoryModalUnit').textContent = currentData.unit || '-';
            document.getElementById('inventoryModalBuyingPrice').textContent = currentData.buying_price === '-' ? '-' : `{{ t('general_currency_symbol', default='₦') }}${currentData.buying_price}`;
            document.getElementById('inventoryModalSellingPrice').textContent = currentData.selling_price === '-' ? '-' : `{{ t('general_currency_symbol', default='₦') }}${currentData.selling_price}`;
            document.getElementById('inventoryModalThreshold').textContent = currentData.threshold;

            // Update action buttons
            document.getElementById('inventoryViewBtn').href = `/inventory/view_page/${currentData._id}`;
            document.getElementById('inventoryEditBtn').href = `/inventory/edit/${currentData._id}`;
            document.getElementById('inventoryDeleteForm').action = `/inventory/delete/${currentData._id}`;
        });
    });

    // Reminder Functionality
    document.getElementById('sendReminderBtn').addEventListener('click', function() {
        if (!currentData) return;

        const reminderType = document.getElementById('reminderType').value;
        const message = document.getElementById('reminderMessage').value;

        if (!message.trim()) {
            alert('{{ t('general_message_required', default='Message is required') }}');
            return;
        }

        this.disabled = true;
        this.textContent = '{{ t('general_sending', default='Sending...') }}';

        const endpoint = currentData._id.includes('creditor') ? '/creditors/send_reminder' : '/debtors/send_reminder';

        fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({
                debtId: currentData._id,
                recipient: currentData.contact,
                message,
                type: reminderType
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('{{ t('general_reminder_sent_successfully', default='Reminder sent successfully') }}');
                bootstrap.Modal.getInstance(document.getElementById('reminderModal')).hide();
                bootstrap.Modal.getInstance(document.getElementById(currentData._id.includes('creditor') ? 'creditorActionsModal' : 'debtorActionsModal')).hide();
                location.reload();
            } else {
                alert('{{ t('general_failed_to_send_reminder', default='Failed to send reminder') }}: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error sending reminder:', error);
            alert('{{ t('general_error_sending_reminder', default='Error sending reminder') }}');
        })
        .finally(() => {
            this.disabled = false;
            this.textContent = '{{ t('general_send_reminder', default='Send Reminder') }}';
        });
    });

    // Snooze Functionality
    document.getElementById('snoozeReminderBtn').addEventListener('click', function() {
        if (!currentData) return;

        const snoozeDays = parseInt(document.getElementById('snoozeDays').value);

        this.disabled = true;
        this.textContent = '{{ t('general_snoozing', default='Snoozing...') }}';

        const endpoint = currentData._id.includes('creditor') ? '/creditors/send_reminder' : '/debtors/send_reminder';

        fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({
                debtId: currentData._id,
                snooze_days: snoozeDays
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('{{ t('general_snooze_set_successfully', default='Snooze set successfully') }}');
                bootstrap.Modal.getInstance(document.getElementById('snoozeModal')).hide();
                bootstrap.Modal.getInstance(document.getElementById(currentData._id.includes('creditor') ? 'creditorActionsModal' : 'debtorActionsModal')).hide();
                location.reload();
            } else {
                alert('{{ t('general_failed_to_set_snooze', default='Failed to set snooze') }}: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error setting snooze:', error);
            alert('{{ t('general_error_setting_snooze', default='Error setting snooze') }}');
        })
        .finally(() => {
            this.disabled = false;
            this.textContent = '{{ t('general_snooze', default='Snooze') }}';
        });
    });
});
</script>
{% endblock %}
